{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% load app_filters %}


{% block title %}{% trans "Thesaurus" %} | {{ block.super }}{% endblock %}

{% block breadcrumb %}
    {% if not object %}
        <li><a href="{% url 'list_descriptor' %}">{% trans "Thesaurus" %}</a>
        <span class="divider">/</span></li>
        <li>{% trans "Descriptors" %}</li>
        <span class="divider">/</span></li>
        <li>{% trans "New Descriptor" %}</li>
    {% else %}
        <li><a href="{% url 'list_descriptor' %}">{% trans "Thesaurus" %}</a>
        <span class="divider">/</span></li>
        <li>{% trans "Edit Descriptor" %}</li>
    {% endif %}
{% endblock %}

{% block content %}

    {% if object %}

    <!-- update -->
        <!-- header -->
        <div class='header'>
            <h2><i class='icon-book'></i>
                {% if object %}
                    {% trans "Edit Descriptor" %}
                    {% for term in formset_term %}
                        <input type="hidden" name="language_system" value="{{ language_system }}">
                        {% if language_system == term.language_code.value and term.concept_preferred_term.value == 'Y' %}
                            : {{ term.term_string.value }}
                        {% endif %}
                    {% endfor %}
                {% endif %}</h2>
        </div>
        <!-- header -->

        <!-- body update -->
        <div class='body'>

            {% if msg_erro %}
                <ul class="errorlist alert alert-error"><li>{{ msg_erro }}</li></ul>
            {% endif  %}
            
            {% if form.errors or formset_descriptor.errors or formset_category.errors or formset_previous.errors or formset_concept.errors %}
                <ul class="errorlist alert alert-error">
                    <li>{% trans "Please check required fields" %}</li>
                </ul>
            {% endif %}

            {{ form.non_form_errors }}
            {{ formset_descriptor.non_form_errors }}
            {{ formset_category.non_form_errors }}
            {{ formset_previous.non_form_errors }}
            {{ formset_concept.non_form_errors }}
            <!-- {{ formset_term.non_form_errors }} -->

            <ul class="nav nav-tabs" id='myTab'>
                <li>
                    <a href="#tab-identifierdesc" class="{% if form.errors and not form.is_valid %}alert-error{% endif %}" data-toggle="tab"><strong>{% trans "Identifier" %}</strong></a>
                </li>

                <li>
                    <!-- <a href="#tab-termlistdesc" class="{% if formset_term.errors and not formset_term.is_valid %}alert-error{% endif %}{% if formset_term.management_form.TOTAL_FORMS.value == 1 %}alert-success{% endif %}" data-toggle="tab" class="active"><strong>{% trans "Terms" %}</strong></a> -->

                    <a href="#tab-termlistdesc" class="" data-toggle="tab" class="active"><strong>{% trans "Terms" %}</strong></a>

                </li>

                <li>
                    <a href="#tab-conceptlistdesc" class="{% if formset_concept.errors and not formset_concept.is_valid %}alert-error{% endif %}" data-toggle="tab"><strong>{% trans "Concept List" %}</strong></a>
                </li>

                <li>
                    <a href="#tab-descriptiondesc" class="{% if formset_descriptor.errors and not formset_descriptor.is_valid %}alert-error{% endif %}{% if formset_descriptor.management_form.TOTAL_FORMS.value == 1 %}alert-success{% endif %}" data-toggle="tab"><strong>{% trans "Description" %}</strong></a>
                </li>
                <li>
                    <a href="#tab-treenumberslistdesc" class="{% if formset_category.errors and not formset_category.is_valid %}alert-error{% endif %}{% if formset_category.management_form.TOTAL_FORMS.value == 1 %}alert-success{% endif %}" data-toggle="tab"><strong>{% trans "Category" %}</strong></a>
                </li>
                <li>
                    <a href="#tab-previousindexinglistdesc" class="{% if formset_previous.errors and not formset_previous.is_valid %}alert-error{% endif %}" data-toggle="tab"><strong>{% trans "Previous indexing" %}</strong></a>
                </li>
            </ul>

            <form method="POST" class="act-form" encrypt="multipart/form-data">{% csrf_token %}

                <input type="hidden" name="action" value="form_update" />

                <div class="tab-content">

                    <div id="tab-identifierdesc" class="tab-pane fade">

                        <fieldset id="identifierdesc">

                            {{ form.non_field_errors.as_ul }}

                            {% for field in form.visible_fields %}
                                {% if field.errors %}
                                    <font color="red"><b>{{ field.label }}</b></font>{{ field.errors }}
                                {% endif %}
                            {% endfor %}

                            <table class="identifierdesc">
                                <thead>
                                    <th>{{ form.thesaurus.label }}<span class="mark">*</span></th>
                                </thead>
                                <tr>
                                    <td>{{ form.thesaurus }}</td>
                                </tr>
                                <thead>
                                    <th>{{ form.descriptor_ui.label }}</th>
                                    <th>{{ form.decs_code.label }}<span class="mark">*</span></th>
                                    <th>{{ form.external_code.label }}</th>
                                    <th>{{ form.nlm_class_number.label }}</th>
                                </thead>
                                <tr>
                                    <td>{{ form.descriptor_ui }}</td>
                                    <td>{{ form.decs_code }}</td>
                                    <td>{{ form.external_code }}</td>
                                    <td>{{ form.nlm_class_number }}</td>
                                </tr>
                                <thead>
                                    <th>{{ form.descriptor_class.label }}</th>
                                    <th>{{ form.date_created.label }}
                                        <font color="#999"><i>{{ form.date_created.help_text }}</i></font>
                                    </th>
                                    <th>{{ form.date_revised.label }}
                                        <font color="#999"><i>{{ form.date_revised.help_text }}</i></font>
                                    </th>
                                    <th>{{ form.date_established.label }}
                                        <font color="#999"><i>{{ form.date_established.help_text }}</i></font>
                                    </th>
                                </thead>
                                <tr>
                                    <td>{{ form.descriptor_class }}</td>
                                    <td>{{ form.date_created }}</td>
                                    <td>{{ form.date_revised }}</td>
                                    <td>{{ form.date_established }}</td>
                                </tr>
                                <tr>
                                    <td colspan=4>{{ form.abbreviation }}</td>
                                </tr>
                            </table>

                        </fieldset>
                    </div>

                    <div id="tab-descriptiondesc" class="tab-pane fade">
                        <fieldset id="descriptiondesc">

                        {{ formset_descriptor.management_form }}

                        {% for form in formset_descriptor %}

                            {{ form.non_field_errors.as_ul }}

                            {% for field in form.visible_fields %}
                                {% if field.errors %}
                                    <font color="red"><b>{{ field.label }}</b></font>{{ field.errors }}
                                {% endif %}
                            {% endfor %}

                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}

                            <table class="accordion-heading">
                                <a class="accordion-toggle" data-toggle="collapse" data-target="#descriptiondesc_{{ form.instance.pk }}">
                                    <font size="2">
                                        {% if form.instance.pk %}
                                            <font color="#333">
                                            <b>
                                            {% for info in info_term_string %}
                                                {% if info.termdesc__language_code = form.language_code.value %}
                                                    {{ info.termdesc__term_string }}
                                                {% endif %}
                                            {% endfor %}

                                            ({{ form.language_code.value }})

                                            </b>
                                            </font>
                                        {% else %}
                                            {% trans 'New Record' %}
                                        {% endif %}

                                    </font>
                                </a>
                            </table>


                            <div id="descriptiondesc_{{ form.instance.pk }}" class="{% if not form.errors %} panel-collapse collapse {% else %} error {% endif %}">


                                <table class="descriptiondesc">
                                    <tr>

                                    {% if form.instance.pk %}
                                        <td colspan="2" class="td-r-del">
                                            {% trans 'Remove' %}? {{ form.DELETE }}
                                        </td>
                                    {% else %}
                                        <td colspan="2" class="term-origin">&nbsp;
                                        </td>
                                    {% endif %}

                                <input name="{{descriptors}}_DELETE" id="id_{{descriptors}}_DELETE" type="hidden">

                                        </td>
                                    </tr>

                                    <tr>
                                        <td width="20%" class="td-r">{{ form.language_code.label_tag }}</td>
                                        <td class="td-l">{{ form.language_code }}</td>
                                    </tr>
                                    <tr>
                                        <td class="td-r">{{ form.annotation.label_tag }}</td>
                                        <td>
                                        {{ form.annotation }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="td-r">{{ form.history_note.label_tag }}</td>
                                        <td>
                                        {{ form.history_note }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="td-r">{{ form.online_note.label_tag }}</td>
                                        <td>
                                        {{ form.online_note }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="td-r">{{ form.public_mesh_note.label_tag }}</td>
                                        <td>
                                        {{ form.public_mesh_note }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="td-r">{{ form.consider_also.label_tag }}</td>
                                        <td>
                                        {{ form.consider_also }}
                                        </td>
                                    </tr>
                                </table>
                                <br>
                            </div>

                        {% endfor %}

                        </fieldset>
                    </div>

                    <div id="tab-treenumberslistdesc" class="tab-pane fade">
                        <fieldset id="treenumberslistdesc">

                            <table class="treenumberslistdesc">
                                <thead>
                                    <th>{% trans "Tree Numbers List" %}</th>
                                    <th>{% trans "Delete?" %}</th>
                                </thead>
                                <tbody>
                                {{ formset_category.management_form }}

                                {% for form in formset_category %}

                                    {{ form.non_field_errors.as_ul }}

                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                    <tr id="category-{{ forloop.counter0 }}" class="category-row{% if form.errors %} error{% endif %} formset-row">
                                        {% for field in form.visible_fields %}
                                       <input type="hidden" id="{{ field.auto_id }}" name="{{ field.html_name }}" value="0" class="keep-field-value" />
                                        <td>
                                            {{ field }}
                                            {{ field.errors }}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </fieldset>
                    </div>

                    <div id="tab-previousindexinglistdesc" class="tab-pane fade">
                        <fieldset id="previousindexinglistdesc">
                            <table class="previousindexinglistdesc">
                                <thead>
                                    <th>{% trans "Previous Index" %}</th>
                                    <th>{% trans "Language" %}</th>
                                    <th>{% trans "Delete?" %}</th>
                                </thead>
                                <tbody>
                                {{ formset_previous.management_form }}

                                {% for form in formset_previous %}

                                    {{ form.non_field_errors.as_ul }}

                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                    <tr id="previous-{{ forloop.counter0 }}" class="previous-row{% if form.errors %} error{% endif %} formset-row">
                                        {% for field in form.visible_fields %}
                                        <td>
                                            {{ field }}
                                            {{ field.errors }}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </fieldset>
                    </div>

                    <div id="tab-conceptlistdesc" class="tab-pane fade">
                        <fieldset id="conceptlistdesc">

                            {{ formset_concept.management_form }}
                            {% for form in formset_concept %}

                                {{ form.non_field_errors.as_ul }}

                                {% for field in form.visible_fields %}
                                    {% if field.errors %}
                                        <font color="red"><b>{{ field.label }}</b></font>{{ field.errors }}
                                    {% endif %}
                                {% endfor %}

                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}

                            <table class="accordion-heading">
                                <a class="accordion-toggle" data-toggle="collapse" data-target="#conceptlistdesc_{{ form.instance.pk }}">
                                    <font size="2">
                                        {% if form.instance.pk %}
                                            <font color="#333">
                                            <b>{{ form.concept_name.value }} ({{ form.language_code.value }})</b>
                                            </font>
                                        {% else %}
                                            {% trans 'New Record' %}
                                        {% endif %}
                                    </font>
                                </a>
                            </table>

                            <div id="conceptlistdesc_{{ form.instance.pk }}" class="{% if not form.errors %} panel-collapse collapse {% else %} error {% endif %}">

                                <table class="conceptlistdesc" border="0">
                                    <tr>

                                    {% if form.instance.pk %}
                                        <td colspan="4" class="td-r-del">
                                            {% trans 'Remove' %}? {{ form.DELETE }}
                                        </td>
                                    {% else %}
                                        <td colspan="4" class="term-origin">&nbsp;
                                        </td>
                                    {% endif %}

                                    <input name="{{conceptlistdesc}}_DELETE" id="id_{{conceptlistdesc}}_DELETE" type="hidden">

                                        </td>
                                    </tr>

                                    <tr>
                                        <td>{{ form.concept_name.label_tag }}</td>
                                        <td>{{ form.language_code.label_tag }}</td>
                                        <td>{{ form.concept_ui.label_tag }}</td>
                                        <td>{{ form.preferred_concept.label_tag }}</td>
                                    </tr>
                                    <tr>
                                        <td class="concept_name">{{ form.concept_name }}</td>
                                        <td>{{ form.language_code }}</td>
                                        <td>{{ form.concept_ui }}</td>
                                        <td>{{ form.preferred_concept }}</td>
                                    </tr>
                                    <tr>
                                        <td colspan="4">{{ form.casn1_name.label_tag }}</td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="casn1">{{ form.casn1_name }}</td>
                                    </tr>
                                    <tr>
                                        <td colspan="4">{{ form.scope_note.label_tag }}</td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="casn1">{{ form.scope_note }}</td>
                                    </tr>

                                    <tr>
                                        <td colspan="4">{{ form.registry_number.label_tag }}</td>
                                    </tr>
                                    <tr>
                                        <td colspan="4">{{ form.registry_number }}</td>
                                    </tr>

                                </table>
                                <br>
                            </div>
                            {% endfor %}
                        </fieldset>
                    </div>

                    <div id="tab-termlistdesc" class="tab-pane fade in active">

                        <fieldset id="termlistdesc">

                            {{ formset_term.management_form }}

                            <a href="{% url 'create_termlistdesc' %}/?identifier_id={{identifier_id}}" class='btn btn-primary'><i class='icon-file'></i> {% trans "New Term" %}</a>
                            </a>
                            <br><br>
                            <!-- Published -->
                            <font class="color_status"><b>{% trans "Published" %}</font><br>
                            {% for form in formset_term %}
                                <!-- Preferred -->
                                {% if form.status.value == 1 and form.concept_preferred_term.value = 'Y' and form.instance.pk %}
                                    {% include "thesaurus/fieldset_termlistdesc.html" %}
                                {% endif %}
                            {% endfor %}

                            {% for form in formset_term %}
                                <!-- Narrower -->
                                {% if form.status.value == 1 and form.concept_preferred_term.value = 'N' and form.instance.pk %}
                                    {% include "thesaurus/fieldset_termlistdesc.html" %}
                                {% endif %}
                            {% endfor %}
                            <br>

                            <!-- Draft -->
                            <font class="color_status"><b>{% trans "Draft" %}</font><br>
                            {% for form in formset_term %}
                                {% if form.status.value == -1 and form.instance.pk %}
                                    {% include "thesaurus/fieldset_termlistdesc.html" %}
                                {% endif %}
                            {% endfor %}
                            <br>

                            <!-- Historical -->
                            <font class="color_status"><b>{% trans "Historical" %}</font><br>
                            {% for form in formset_term %}
                                {% if form.status.value == 5 and form.instance.pk %}
                                    {% include "thesaurus/fieldset_termlistdesc.html" %}
                                {% endif %}
                            {% endfor %}

                        </fieldset>
                    </div>

                </div>




                <div class="control-panel form-submit">
                    <a href="{% url 'list_descriptor' %}" class="btn btn-large btn-danger" onClick="setNoneTab()">{% trans "Cancel" %}</a>
                    <button class="btn btn-primary btn-large">{% trans "Save" %}</button>

                    {% if messages %}
                        {% for message in messages %}
                            <font color="#333" size="4">
                                <b>{% trans "Registry successfully saved" %}</b>
                            </font>
                        {% endfor %}
                    {% endif %}

                </div>

            </form>

                </br>

                {% if object.id %}
                    <!-- <div class="alert alert-info">
                        <p>{% trans "Created in" %}: <strong>{{ object.created_time }}</strong> {% trans "by user" %}  <strong>{{ object.created_by.username }}</strong></p>
                        <p>{% trans "Cooperative center code" %}: <strong>{{ object.cooperative_center_code }}</strong></p>
                        {% if act.updated_by %}
                            <p>{% trans "Last edit in" %} <strong>{{ object.updated_time }}</strong> {% trans "by user" %}  <strong>{{ object.updated_by.username }}</strong></p>
                        {% endif %}
                    </div> -->
                    <div class="btn-group pull-right">
                        <a href="#" data-toggle="modal" data-target="#log_modal" data-remote="/log/view/{{c_type.id}}/{{object.id}}/" class="btn"><i class="icon icon-time"></i> {% trans "Changes history" %}</a>
                    </div>
                {% endif %}

                {% if object.id %}
                    {% include "modal_log.html" %}
                {% endif %}

        </div>
        <!-- body update -->

    <!-- update -->

    {% else %}

    <!-- new register -->

        <div class='header'>
            <h2><i class='icon-book'></i>
                {% if not object %}
                    {% trans "New Descriptor" %}
                    <!-- {% if next_id %}
                         - ID: {{ next_id }}
                    {% endif %} -->
                {% endif %}</h2>
        </div>

        <div class='body'>

            {% if msg_erro %}
                <ul class="errorlist alert alert-error"><li>{{ msg_erro }}</li></ul>
            {% endif  %}

            {% if form.errors or formset_descriptor.errors or formset_category.errors or formset_previous.errors or formset_concept.errors or formset_term.errors %}
                <ul class="errorlist alert alert-error">
                    <li>{% trans "Please check required fields" %}</li>
                </ul>
            {% endif %}

            <ul class="nav nav-tabs" id='myTab'>
                <li>
                    <a href="#tab-identifierdesc" class="{% if form.errors and not form.is_valid %}alert-error{% endif %}" data-toggle="tab"><strong>{% trans "Identifier" %}</strong></a>
                </li>

                <li>
                    <a href="#tab-termlistdesc" class="{% if formset_term.errors and not formset_term.is_valid %}alert-error{% endif %}" data-toggle="tab"><strong>{% trans "Terms" %}</strong></a>
                </li>

                <li>
                    <a href="#tab-conceptlistdesc" class="{% if formset_concept.errors and not formset_concept.is_valid %}alert-error{% endif %}" data-toggle="tab"><strong>{% trans "Concept List" %}</strong></a>
                </li>

                <li>
                    <a href="#tab-descriptiondesc" class="{% if formset_descriptor.errors and not formset_descriptor.is_valid %}alert-error{% endif %}" data-toggle="tab"><strong>{% trans "Description" %}</strong></a>
                </li>
                <li>
                    <a href="#tab-treenumberslistdesc" class="{% if formset_category.errors and not formset_category.is_valid %}alert-error{% endif %}" data-toggle="tab"><strong>{% trans "Category" %}</strong></a>
                </li>
                <li>
                    <a href="#tab-previousindexinglistdesc" class="{% if formset_previous.errors and not formset_previous.is_valid %}alert-error{% endif %}" data-toggle="tab"><strong>{% trans "Previous indexing" %}</strong></a>
                </li>
            </ul>



            <form method="POST" class="act-form" encrypt="multipart/form-data" id="regForm">{% csrf_token %}
            
            <input type="hidden" name="action" value="form_new" />

                <!-- tab-identifierdesc -->
                <div class="tab">
                    <fieldset id="identifierdesc">
                    <h2>{% trans "Identifier" %}</h2>

                    {{ form.non_field_errors.as_ul }}

                    {% for field in form.visible_fields %}
                        {% if field.errors %}
                            <font color="red"><b>{{ field.label }}</b></font>{{ field.errors }}
                        {% endif %}
                    {% endfor %}

                    <table class="identifierdesc">
                        <thead>
                            <th>{{ form.thesaurus.label }}<span class="mark">*</span></th>
                        </thead>
                        <tr>
                            <td>{{ form.thesaurus }}</td>
                        </tr>
                        <thead>
                            <th>{{ form.descriptor_ui.label }}</th>
                            <th>{{ form.decs_code.label }}<span class="mark">*</span></th>
                            <th>{{ form.external_code.label }}</th>
                            <th>{{ form.nlm_class_number.label }}</th>
                        </thead>
                        <tr>
                            <td>
                                {{ form.descriptor_ui }}
                                <!-- <input id="id_descriptor_ui" maxlength="250" name="descriptor_ui" value="{% if form.descriptor_ui.value %}{{form.descriptor_ui.value}}{% endif %}" type="text" required="true"> -->
                            </td>
                            <td>
                                <!-- {{ form.decs_code }} -->
                                <input id="id_decs_code" maxlength="250" name="decs_code" value="{% if form.decs_code.value %}{{form.decs_code.value}}{% endif %}" type="text" required="true">
                            </td>

                            <td>{{ form.external_code }}</td>
                            <td>{{ form.nlm_class_number }}</td>
                        </tr>
                        <thead>
                            <th>{{ form.descriptor_class.label }}</th>
                            <th>{{ form.date_created.label }}
                                <font color="#999"><i>{{ form.date_created.help_text }}</i></font>
                            </th>
                            <th>{{ form.date_revised.label }}
                                <font color="#999"><i>{{ form.date_revised.help_text }}</i></font>
                            </th>
                            <th>{{ form.date_established.label }}
                                <font color="#999"><i>{{ form.date_established.help_text }}</i></font>
                            </th>
                        </thead>
                        <tr>
                            <td>{{ form.descriptor_class }}</td>
                            <td>{{ form.date_created }}</td>
                            <td>{{ form.date_revised }}</td>
                            <td>{{ form.date_established }}</td>
                        </tr>
                        <tr>
                            <td colspan=4>{{ form.abbreviation }}</td>
                        </tr>
                    </table>
                    </fieldset>
                </div>

                <!-- tab-termlistdesc -->
                <div class="tab">
                    <fieldset id="termlistdesc">
                        <h2>{% trans "Terms" %}</h2>
                        <!-- {{ formset_term.as_table }} -->
                        {{ formset_term.management_form }}

                        {% for form in formset_term %}

                            {{ form.non_field_errors.as_ul }}

                            {% for field in form.visible_fields %}
                                {% if field.errors %}
                                    <font color="red"><b>{{ field.label }}</b></font>{{ field.errors }}
                                {% endif %}
                            {% endfor %}

                            <table class="termlistdesc">
                                <td colspan="5">
                                    {{ form.status.label_tag }}
                                    {{ form.status }}
                                </td>

                                <tr>
                                    <td colspan="2" class="term_string" width="40%">
                                        <label for="term_string">{{ form.term_string.label_tag }}</label>
                                    </td>
                                    <td>{{ form.language_code.label_tag }}</td>
                                    <td>{{ form.term_ui.label_tag }}</td>
                                    <td>{{ form.date_created.label_tag }}</td>
                                </tr>
                                <tr>
                                    <td colspan="2" class="term_string" width="40%">
                                        <!-- {{ form.term_string }} -->
                                        <input id="id_termdesc-0-term_string" maxlength="250" name="termdesc-0-term_string" value="{% if form.term_string.value %}{{form.term_string.value}}{% endif %}" type="text" required="true">
                                    </td>
                                    <td>
                                        <!-- {{ form.language_code }} -->
                                        <select id="id_termdesc-0-language_code" name="termdesc-0-language_code" required="true">
                                            <option value="">{% if not form.language_code.value %}---------{% endif %}</option>
                                            <option value="en" {% if form.language_code.value == 'en'%}selected{% endif %}>{% trans "English" %}</option>
                                            <option value="es" {% if form.language_code.value == 'es'%}selected{% endif %}>{% trans "Spanish Latin America" %}</option>
                                            <option value="pt-br" {% if form.language_code.value == 'pt-br'%}selected{% endif %}>{% trans "Portuguese" %}</option>
                                            <option value="es-es" {% if form.language_code.value == 'es-es'%}selected{% endif %}>{% trans "Spanish Spain" %}</option>
                                            <option value="fr" {% if form.language_code.value == 'fr'%}selected{% endif %}>{% trans "French" %}</option>
                                        </select>
                                    </td>
                                    <td>{{ form.term_ui }}</td>
                                    <td>
                                        <!-- {{ form.date_created }} -->
                                        <input id="id_termdesc-0-date_created" name="termdesc-0-date_created" type="text" value="{% now 'd/m/Y' %}" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>{{ form.concept_preferred_term.label_tag }}</td>
                                    <td>{{ form.is_permuted_term.label_tag }}</td>
                                    <td>{{ form.lexical_tag.label_tag }}</td>
                                    <td>{{ form.record_preferred_term.label_tag }}</td>
                                    <td>{{ form.entry_version.label_tag }}</td>
                                </tr>
                                <tr>
                                    <td>
                                        <!-- {{ form.concept_preferred_term }} -->
                                        <select id="id_termdesc-0-concept_preferred_term" name="termdesc-0-concept_preferred_term" required="true">
                                            <option value="">---------</option>
                                            <option value="Y" {% if form.concept_preferred_term.value == 'Y' %}selected{% endif %}>{% trans "Yes" %}</option>
                                            <option value="N" {% if form.concept_preferred_term.value == 'N' %}selected{% endif %}>{% trans "No" %}</option>
                                        </select>
                                    </td>
                                    <td>{{ form.is_permuted_term }}</td>
                                    <td>{{ form.lexical_tag }}</td>
                                    <td>{{ form.record_preferred_term }}</td>
                                    <td>{{ form.entry_version }}</td>
                                </tr>

                                <tr>
                                    <td colspan="4" width="100%">{{ form.historical_annotation.label_tag }}</td>
                                    <td>{{ form.date_altered.label_tag }}</td>
                                </tr>
                                <tr>
                                    <td colspan="4" width="100%">{{ form.historical_annotation }}</td>
                                    <td valign="top">
                                        <!-- {{ form.date_altered }} -->
                                        <input id="id_termdesc-0-date_altered" name="termdesc-0-date_altered" type="text" value="{% now 'd/m/Y' %}" />
                                    </td>
                                </tr>
                            </table>
                        {% endfor %}
                    </fieldset>
                </div>

                <!-- tab-descriptiondesc -->
                <div class="tab">
                    <fieldset id="descriptiondesc">
                    <!-- {{ formset_descriptor.as_table }} -->
                        <h2>{% trans "Description" %}</h2>

                        {{ formset_descriptor.management_form }}

                        {% for form in formset_descriptor %}

                            {{ form.non_field_errors.as_ul }}

                            {% for field in form.visible_fields %}
                                {% if field.errors %}
                                    <font color="red"><b>{{ field.label }}</b></font>{{ field.errors }}
                                {% endif %}
                            {% endfor %}

                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}

                            <table class="descriptiondesc">
                                <tr>
                                    <td width="20%" class="td-r">{{ form.language_code.label_tag }}</td>
                                    <td class="td-l">
                                        <!-- {{ form.language_code }} -->
                                        <select id="id_descriptors-0-language_code" name="descriptors-0-language_code" required="true">
                                            <option value="">{% if not form.language_code.value %}---------{% endif %}</option>
                                            <option value="en" {% if form.language_code.value == 'en'%}selected{% endif %}>{% trans "English" %}</option>
                                            <option value="es" {% if form.language_code.value == 'es'%}selected{% endif %}>{% trans "Spanish Latin America" %}</option>
                                            <option value="pt-br" {% if form.language_code.value == 'pt-br'%}selected{% endif %}>{% trans "Portuguese" %}</option>
                                            <option value="es-es" {% if form.language_code.value == 'es-es'%}selected{% endif %}>{% trans "Spanish Spain" %}</option>
                                            <option value="fr" {% if form.language_code.value == 'fr'%}selected{% endif %}>{% trans "French" %}</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="td-r">{{ form.annotation.label_tag }}</td>
                                    <td>
                                        <!-- {{ form.annotation }} -->
                                        <textarea cols="40" id="id_descriptors-0-annotation" maxlength="1500" name="descriptors-0-annotation" rows="10" required="true"></textarea>

                                    </td>
                                </tr>
                                <tr>
                                    <td class="td-r">{{ form.history_note.label_tag }}</td>
                                    <td>
                                    {{ form.history_note }}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="td-r">{{ form.online_note.label_tag }}</td>
                                    <td>
                                    {{ form.online_note }}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="td-r">{{ form.public_mesh_note.label_tag }}</td>
                                    <td>
                                    {{ form.public_mesh_note }}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="td-r">{{ form.consider_also.label_tag }}</td>
                                    <td>
                                    {{ form.consider_also }}
                                    </td>
                                </tr>
                            </table>
                        {% endfor %}
                    </fieldset>
                </div>

                <!-- tab-treenumberslistdesc -->
                <div class="tab">
                    <!-- {{ formset_category.as_table }} -->
                    <fieldset id="treenumberslistdesc">
                        <h2>{% trans "Category" %}</h2>
                        <table class="treenumberslistdesc">
                            <thead>
                                <th>{% trans "Tree Numbers List" %}</th>
                                <th>{% trans "Delete?" %}</th>
                            </thead>
                            <tbody>
                            {{ formset_category.management_form }}

                            {% for form in formset_category %}

                                {{ form.non_field_errors.as_ul }}

                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                <tr id="category-{{ forloop.counter0 }}" class="category-row{% if form.errors %} error{% endif %} formset-row">
                                    {% for field in form.visible_fields %}
                                    <td>
                                        {{ field }}
                                        {{ field.errors }}
                                    </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </fieldset>
                </div>

                <!-- tab-conceptlistdesc -->
                <div class="tab">
                    <fieldset id="conceptlistdesc">
                    <!-- {{ formset_concept.as_table }} -->
                        <h2>{% trans "Concept List" %}</h2>

                        {{ formset_concept.management_form }}
                        {% for form in formset_concept %}

                            {{ form.non_field_errors.as_ul }}

                            {% for field in form.visible_fields %}
                                {% if field.errors %}
                                    <font color="red"><b>{{ field.label }}</b></font>{{ field.errors }}
                                {% endif %}
                            {% endfor %}

                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}

                            <table class="conceptlistdesc" border="0">
                                <tr>
                                    <td>{{ form.concept_name.label_tag }}</td>
                                    <td>{{ form.language_code.label_tag }}</td>
                                    <td>{{ form.concept_ui.label_tag }}</td>
                                    <td>{{ form.preferred_concept.label_tag }}</td>
                                </tr>
                                <tr>
                                    <td class="concept_name">{{ form.concept_name }}</td>
                                    <td>{{ form.language_code }}</td>
                                    <td>{{ form.concept_ui }}</td>
                                    <td>{{ form.preferred_concept }}</td>
                                </tr>
                                <tr>
                                    <td colspan="4">{{ form.casn1_name.label_tag }}</td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="casn1">{{ form.casn1_name }}</td>
                                </tr>
                                <tr>
                                    <td colspan="4">{{ form.scope_note.label_tag }}</td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="casn1">{{ form.scope_note }}</td>
                                </tr>

                                <tr>
                                    <td colspan="4">{{ form.registry_number.label_tag }}</td>
                                </tr>
                                <tr>
                                    <td colspan="4">{{ form.registry_number }}</td>
                                </tr>

                            </table>
                        {% endfor %}
                    </fieldset>
                </div>

                <!-- tab-previousindexinglistdesc -->
                <div class="tab">
                    <!-- {{ formset_previous.as_table }} -->
                    <fieldset id="previousindexinglistdesc">
                        <h2>{% trans "Previous indexing" %}</h2>

                        <table class="previousindexinglistdesc">
                            <thead>
                                <th>{% trans "Previous Index" %}</th>
                                <th>{% trans "Language" %}</th>
                                <th>{% trans "Delete?" %}</th>
                            </thead>
                            <tbody>
                            {{ formset_previous.management_form }}

                            {% for form in formset_previous %}

                                {{ form.non_field_errors.as_ul }}

                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                <tr id="previous-{{ forloop.counter0 }}" class="previous-row{% if form.errors %} error{% endif %} formset-row">
                                    {% for field in form.visible_fields %}
                                    <td>
                                        {{ field }}
                                        {{ field.errors }}
                                    </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </fieldset>
                </div>

                <table align="center">
                    <tr><td>
                    <div style="overflow:auto;">
                        <div style="float:right;">
                            <button type="button" id="prevBtn" onclick="nextPrev(-1)">Previous</button>
                            <button type="button" id="nextBtn" onclick="nextPrev(1)">Next</button>
                        </div>
                    </div>
                </td></tr>
                </table>

                <!-- Circles which indicates the steps of the form: -->
                <div style="text-align:center;margin-top:40px;">
                    <span class="step"></span>
                    <span class="step"></span>
                    <span class="step"></span>
                    <span class="step"></span>
                    <span class="step"></span>
                    <span class="step"></span>
                </div>

                <div>
                    <a href="{% url 'list_descriptor' %}" class="btn btn-large btn-danger" onClick="setNoneTab()">{% trans "Cancel" %}</a>
                </div>

            <form>
        </div>





        <script type="text/javascript">

            var currentTab = 0; // Current tab is set to be the first tab (0)
            showTab(currentTab); // Display the current tab

            function showTab(n) {
                // This function will display the specified tab of the form ...
                var x = document.getElementsByClassName("tab");
                x[n].style.display = "block";
                // ... and fix the Previous/Next buttons:
                if (n == 0) {
                   document.getElementById("prevBtn").style.display = "none";
                } else {
                    document.getElementById("prevBtn").style.display = "inline";
                }
                if (n == (x.length - 1)) {
                    document.getElementById("nextBtn").innerHTML = "Submit";
                } else {
                    document.getElementById("nextBtn").innerHTML = "Next";
                }
                // ... and run a function that displays the correct step indicator:
                fixStepIndicator(n)
            }

            function nextPrev(n) {
                // This function will figure out which tab to display
                var x = document.getElementsByClassName("tab");
                // Exit the function if any field in the current tab is invalid:
                if (n == 1 && !validateForm()) return false;
                // Hide the current tab:
                x[currentTab].style.display = "none";
                // Increase or decrease the current tab by 1:
                currentTab = currentTab + n;
                // if you have reached the end of the form... :
                if (currentTab >= x.length) {
                    //...the form gets submitted:
                    document.getElementById("regForm").submit();
                    return false;
                }
                // Otherwise, display the correct tab:
                showTab(currentTab);
            }

        function validateForm() {
            // This function deals with validation of the form fields
            var x, y, i, valid = true;
            x = document.getElementsByClassName("tab");
            y = x[currentTab].getElementsByTagName("input");

            // // A loop that checks every input field in the current tab:
            // for (i = 0; i < y.length; i++) {
            //   // If a field is empty...
            //   if (y[i].value == "") {
            //     // add an "invalid" class to the field:
            //     y[i].className += " invalid";
            //     // and set the current valid status to false:
            //     // valid = false;
            //     valid = true;
            //   }
            // }

            // A loop that checks every input field in the current tab:
            for (i = 0; i < y.length; i++) {
            // If a field is empty...
            if (y[i].getAttribute('required') == 'true' && y[i].value == "") {
            // add an "invalid" class to the field:
            y[i].className += " invalid";
            // and set the current valid status to false:
            valid = false;
            // valid = true;
            }
        }


        // If the valid status is true, mark the step as finished and valid:
        if (valid) {
            document.getElementsByClassName("step")[currentTab].className += " finish";
        }
            return valid; // return the valid status
        }

        function fixStepIndicator(n) {
            // This function removes the "active" class of all steps...
            var i, x = document.getElementsByClassName("step");
            for (i = 0; i < x.length; i++) {
               x[i].className = x[i].className.replace(" active", "");
            }
            //... and adds the "active" class to the current step:
            x[n].className += " active";
        }

        </script>

    <!-- new register -->


    {% endif %}


    <script src="{% static "site/js/jquery.js" %}"></script>
    <script type="text/javascript" src="{% static "admin/js/jquery.init.js" %}"></script>
    <script type="text/javascript" src="/admin/jsi18n/"></script>
    <script type="text/javascript" src="{% static "admin/js/core.js" %}"></script>
    <script type="text/javascript" src="{% static "admin/js/SelectBox.js" %}"></script>
    <script type="text/javascript" src="{% static "admin/js/SelectFilter2.js" %}"></script>
    <script type="text/javascript">
        // PARAMETROS DO SELECT FILTER:
        // ID do seu elemento select
        // NAME do seu elemento select
        // 0 - para filter_horizontal / 1 para filter_vertical
        // Caminho do admin para source de imagens utilizadas

        addEvent(window, "load", function(e) {SelectFilter.init("id_abbreviation", "abbreviation", 1, "/static/admin/"); });
    </script>



{% endblock %}




{% block extrajs %}
   <script src="{% static 'js/jquery.formset.js' %}"></script>
   <script src="{% static 'js/bootstrap-datepicker.min.js' %}"></script>
   <script src="{% static 'js/bootstrap-collapse.js' %}"></script>



   {% if LANGUAGE_CODE != 'en' %}
       <script src="{% static ''%}js/bootstrap-datepicker.{{LANGUAGE_CODE}}.min.js"></script>
   {% endif %}

   <script type="text/javascript">


        // Faz com que o ultimo form salvo fique ativo apos reload
        $(document).ready(function(){

            // Armazena em activeTab informação da aba ativa
            $('a[data-toggle="tab"]').on('show.bs.tab', function(e) {
                localStorage.setItem('activeTab', $(e.target).attr('href'));

                // Armazena URL atual
                var old_currentLocation = window.location.href;
                localStorage.setItem('old_currentLocation', old_currentLocation);

            });

            // Traz variavel activeTab armazenada
            var activeTab = localStorage.getItem('activeTab');
            // Traz variavel old_currentLocation armazenada
            var old_currentLocation = localStorage.getItem('old_currentLocation');
            // Faz colta da URL atual
            var currentLocation = window.location.href;
            if(activeTab){
                // Compara se é a mesma URL, ou seja se ainda está na mesma página
                if (old_currentLocation != currentLocation){ // Se não estiver remove informações
                    localStorage.removeItem('activeTab');
                    localStorage.removeItem('old_currentLocation');
                } else { // Se estiver na mesma página posiciona na Aba visitada anteriormente.
                    $('#myTab a[href="' + activeTab + '"]').tab('show');
                }
            }
        });


        // Apaga localStorage quando eh novo registro
        $('[id="myTabNew"]').on('submit', function() {
            localStorage.removeItem('activeTab');
            localStorage.removeItem('old_currentLocation');
        });


        // Apaga localStorage quando volta a pagina inicial
        function setNoneTab(){
            localStorage.removeItem('activeTab');
            localStorage.removeItem('old_currentLocation');
        }


        $(function() {
            $('.category-row').formset({
                    addText : '{% trans "Add Tree Number" %}',
                    deleteText: '{% trans "delete" %}',
                    addCssClass : 'icon-plus-sign btn',
                    deleteCssClass : 'btn',
                    keepFieldValues: '.keep-field-value',
                    formCssClass: 'category_formset',
                    prefix: '{{ formset_category.prefix }}'
            });

            $('.previous-row').formset({
                    addText : '{% trans "Add Previous Index" %}',
                    deleteText: '{% trans "delete" %}',
                    addCssClass : 'icon-plus-sign btn',
                    deleteCssClass : 'btn',
                    keepFieldValues: '.keep-field-value',
                    formCssClass: 'previous_formset',
                    prefix: '{{ formset_previous.prefix }}'
            });


            $('[id^="id_treenumberslistdesc_set-"]').on('blur', function() {
                val = $(this).val();
                $(this).val(val.replace(/\s/g, ''));

                tam = val.length;
                // alert(tam);
                if( tam % 2 !== 0 ){
                    // É impar
                    // alert("Impar "+tam);
                    // Verifica quantidade de pontos
                    qtd_pontos = ((tam + 1) / 4) - 1;
                    // alert('Numero de pontos:'+qtd_pontos);
                    if ( !( (parseFloat(qtd_pontos) == parseInt(qtd_pontos)) && !isNaN(qtd_pontos) ) ) {
                        // alert("Não é inteiro"+qtd_pontos)
                        alert('{% trans "Warning" %}: '+$(this).val());
                        return false
                    } else {
                        $(this).val;
                    }

                } else {
                    // se eh par está errado
                    if ( tam != 0 ){
                        alert('{% trans "Warning" %}: '+$(this).val());
                        return false
                    }
                }
            });

            $('.act-form').on('submit', function() {
                if (confirm('{% trans "Save" %}?')) {
                    return true;
                } else {
                    return false;
                }
            });

            $('[id$="-DELETE"]').on('click', function() {
                val = $(this).val();
                if (confirm('{% trans "Delete" %}?')) {
                    return true;
                } else {
                    return false;

                }
            });





            // Alerta sobre não preenchimento
            // $('[id^="id_descriptors-"]').on('blur', function() {
            //     val = $(this).val();
            //     if ( val == '' ){
            //         alert('{% trans "Warning" %}');
            //         return false;
            //     }
            // });


            // // Alerta sobre não preenchimento
            // $('[id$="-term_string"]').on('blur', function() {
            //     val = $(this).val();
            //     if ( val == '' ){
            //         // alert('{% trans "Warning: Field is empty!" %}');
            //         alert('{% trans "Warning: Field is empty!" %}: '+$(this).val());
            //         return false;
            //     }
            // });


            if ($("<input />").prop("required") === undefined) {
              $(document).on("submit", function(e) {
                $(this)
                  .find("input, select, textarea")
                  .filter("[required]")
                  .filter(function() { return this.value == ''; })
                  .each(function() {
                    e.preventDefault();
                    $(this).css({ "border": "2px solid red" })
                    alert($(this).prev('label').html() + " é obrigatório.");
                  });
              });
            }

        })



        function mascara(o,f){
            v_obj=o
            v_fun=f
            setTimeout("execmascara()",1)
        }
        function execmascara(){
            v_obj.value=v_fun(v_obj.value)
        }
        function mdata(v){
            v=v.replace(/\D/g,"");
            v=v.replace(/(\d{2})(\d)/,"$1/$2");
            v=v.replace(/(\d{2})(\d)/,"$1/$2");

            v=v.replace(/(\d{2})(\d{2})$/,"$1$2");
            return v;
        }




   </script>

{% endblock %}